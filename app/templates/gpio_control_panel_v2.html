<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sh_IoT WebApp GPIO Control (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
<div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow">
    <h1 class="text-2xl font-bold mb-4 text-center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPIO (ESP32-S3)</h1>

    <div id="user_info" class="text-center text-gray-400 mb-6">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>

    <div id="pins_container" class="space-y-4"></div>

    <div class="mt-8 text-sm text-gray-300" id="log">–õ–æ–≥: ...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
<div id="schedule_modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
        <h2 class="text-lg font-semibold mb-4">–ó–∞–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
        <div class="mb-4">
            <label for="on_time_input" class="block text-gray-300 mb-1">–í—Ä–µ–º—è –≤–∫–ª—é—á–µ–Ω–∏—è:</label>
            <input id="on_time_input" type="time" class="w-full p-2 rounded bg-gray-700 text-white"/>
        </div>
        <div class="mb-4">
            <label for="off_time_input" class="block text-gray-300 mb-1">–í—Ä–µ–º—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è:</label>
            <input id="off_time_input" type="time" class="w-full p-2 rounded bg-gray-700 text-white"/>
        </div>
        <div class="flex justify-end space-x-2">
            <button id="cancel_schedule_btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded">–û—Ç–º–µ–Ω–∞</button>
            <button id="save_schedule_btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="schedule_error" class="mt-2 text-sm text-red-400 hidden">–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è</div>
    </div>
</div>

<script>
    const baseUrl = "https://shiotstandard-production.up.railway.app";
    const wsUrl = "wss://shiotstandard-production.up.railway.app/devices/ws/1/connect";
    const wsToken = "abc123";

    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe.user;
    document.getElementById("user_info").innerText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user?.first_name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'} (ID: ${user?.id || 'N/A'})`;

    const pins = [4, 5, 6, 15, 16, 17, 18, 21, 22, 23];
    const pinsInfo = {};
    let socket = null;

    pins.forEach(pin => {
        pinsInfo[pin] = {state: null, mode: 'manual', schedule: {on: '08:00', off: '18:00'}};
    });

    function renderUI() {
        const container = document.getElementById("pins_container");
        container.innerHTML = '';

        pins.forEach(pin => {
            const info = pinsInfo[pin];
            const block = document.createElement("div");
            block.className = "bg-gray-700 p-4 rounded space-y-2";

            const statusText = info.state === 1 ? '–í–ö–õ' : info.state === 0 ? '–í–´–ö–õ' : '‚Äî';
            const statusColor = info.state === 1 ? 'text-green-400' : info.state === 0 ? 'text-red-400' : 'text-gray-400';

            block.innerHTML = `
          <div class="flex justify-between items-center">
            <div class="text-lg">GPIO ${pin}</div>
            <select id="mode-select-${pin}" class="bg-gray-600 text-white px-2 py-1 rounded">
              <option value="manual">–†—É—á–Ω–æ–π</option>
              <option value="auto">–ê–≤—Ç–æ</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <button id="toggle-btn-${pin}" class="px-4 py-1 rounded ">${info.state === 1 ? '–í–´–ö–õ' : '–í–ö–õ'}</button>
            <button id="auto-btn-${pin}" class="px-4 py-1 rounded">–ê–í–¢–û</button>
          </div>
          <div id="schedule-label-${pin}" class="text-sm text-yellow-400 hidden">–í—Ä–µ–º—è: ${info.schedule.on}‚Äì${info.schedule.off}</div>
          <div class="text-sm text-gray-300">–°—Ç–∞—Ç—É—Å: <span id="status-${pin}" class="${statusColor}">${statusText}</span></div>
          <div class="text-sm text-gray-400">–†–µ–∂–∏–º: <span id="mode-label-${pin}">${info.mode === 'auto' ? '–ê–≤—Ç–æ' : '–†—É—á–Ω–æ–π'}</span></div>
        `;

            container.appendChild(block);

            const modeSelect = document.getElementById(`mode-select-${pin}`);
            modeSelect.value = info.mode;
            modeSelect.addEventListener('change', () => send({type: 'mode', pin, mode: modeSelect.value}));

            const toggleBtn = document.getElementById(`toggle-btn-${pin}`);
            const autoBtn = document.getElementById(`auto-btn-${pin}`);
            const scheduleLabel = document.getElementById(`schedule-label-${pin}`);

            if (info.mode === 'auto') {
                toggleBtn.disabled = true;
                toggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                autoBtn.innerText = '–†—É—á–Ω–æ–π';
                scheduleLabel.classList.remove('hidden');
                autoBtn.addEventListener('click', () => send({type: 'mode', pin, mode: 'manual'}));
            } else {
                toggleBtn.disabled = false;
                toggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                toggleBtn.classList.toggle('bg-green-600', info.state !== 1);
                toggleBtn.classList.toggle('hover:bg-green-700', info.state !== 1);
                toggleBtn.classList.toggle('bg-red-600', info.state === 1);
                toggleBtn.classList.toggle('hover:bg-red-700', info.state === 1);
                toggleBtn.innerText = info.state === 1 ? '–í–´–ö–õ' : '–í–ö–õ';
                toggleBtn.addEventListener('click', () => send({type: 'gpio', pin, state: info.state === 1 ? 0 : 1}));

                autoBtn.innerText = '–ê–í–¢–û';
                scheduleLabel.classList.add('hidden');
                autoBtn.addEventListener('click', () => openScheduleModal(pin));
            }
        });
    }

    function send(obj) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(obj));
        } else {
            log('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω', true);
        }
    }

    function setupWebSocket() {
        socket = new WebSocket(wsUrl);

        socket.addEventListener('open', () => {
            send({auth_token: wsToken, client: 'web'});
            log('WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω');
        });

        socket.addEventListener('message', event => {
            try {
                const data = JSON.parse(event.data);

                // üìå –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º full_status
                if (data.type === 'full_status') {
                    for (const [pinStr, info] of Object.entries(data.pins || {})) {
                        const pin = Number(pinStr);
                        if (!pinsInfo[pin]) continue;
                        pinsInfo[pin].state = info.state;
                        pinsInfo[pin].mode = info.mode;
                        if (info.schedule) {
                            pinsInfo[pin].schedule.on = info.schedule.on;
                            pinsInfo[pin].schedule.off = info.schedule.off;
                        }
                    }
                    renderUI();
                    return;
                }

                // üìå –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∏–Ω
                if ('pin' in data && pinsInfo[data.pin]) {
                    const info = pinsInfo[data.pin];
                    if ('state' in data) info.state = data.state;
                    if ('mode' in data) info.mode = data.mode;
                    if ('schedule' in data) {
                        info.schedule.on = data.schedule.on;
                        info.schedule.off = data.schedule.off;
                    }
                    renderUI();
                    return;
                }

                // üìå –õ–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (data.type === 'info') {
                    log(data.message);
                    return;
                }

            } catch (err) {
                log('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ WS —Å–æ–æ–±—â–µ–Ω–∏—è: ' + err.message, true);
            }
        });


        socket.addEventListener('close', () => {
            log('WS –æ—Ç–∫–ª—é—á—ë–Ω. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫.');
            setTimeout(setupWebSocket, 5000);
        });

        socket.addEventListener('error', err => {
            log('WS –æ—à–∏–±–∫–∞: ' + err.message, true);
            socket.close();
        });
    }

    function openScheduleModal(pin) {
        currentPinForSchedule = pin;
        document.getElementById('on_time_input').value = pinsInfo[pin].schedule.on;
        document.getElementById('off_time_input').value = pinsInfo[pin].schedule.off;
        document.getElementById('schedule_error').classList.add('hidden');
        document.getElementById('schedule_modal').classList.remove('hidden');
    }

    function closeScheduleModal() {
        currentPinForSchedule = null;
        document.getElementById('schedule_modal').classList.add('hidden');
    }

    async function saveSchedule() {
        const onTime = document.getElementById('on_time_input').value;
        const offTime = document.getElementById('off_time_input').value;
        if (!onTime || !offTime || onTime >= offTime) {
            document.getElementById('schedule_error').innerText = '–í—Ä–µ–º—è –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è';
            document.getElementById('schedule_error').classList.remove('hidden');
            return;
        }
        const pin = currentPinForSchedule;
        send({type: 'schedule', pin, on_time: onTime, off_time: offTime});
        pinsInfo[pin].schedule = {on: onTime, off: offTime};
        pinsInfo[pin].mode = 'auto';
        pinsInfo[pin].state = 0;
        renderUI();
        closeScheduleModal();
        log(`–ó–∞–¥–∞–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ GPIO ${pin}: ${onTime}‚Äì${offTime}`);
    }

    document.getElementById('cancel_schedule_btn').addEventListener('click', closeScheduleModal);
    document.getElementById('save_schedule_btn').addEventListener('click', saveSchedule);

    function log(message, isError = false) {
        const el = document.getElementById('log');
        el.innerText = `–õ–æ–≥: ${message}`;
        el.classList.toggle('text-red-400', isError);
        el.classList.toggle('text-gray-300', !isError);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupWebSocket();
    });
</script>
</body>
</html>
